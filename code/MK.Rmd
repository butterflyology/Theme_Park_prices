---
title: "Magic Kingdom Ticket Prices"
author: "Chris Hamm"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
 # pdf_document:
 #   toc: true
 #   number_sections: true
 #   fig_caption: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
```

# Introduction
Trips to Walt Disney World are expensive and one of the more frustration things is the price of a ticket. It seems that every few months we hear about another hike for the cost of tickets. With the recent news that [variable pricing](http://time.com/money/5405838/disney-world-ticket-prices-2018/) for tickets is one the way I wanted to take a look at the history of the cost of a single day admission to the Magic Kingdom and ask a few quesitons:

1. Has the rate of increase gotten higher recently?
1. Did the different Disney CEOs raise ticket prices at different rates? 
1. Adjusted for inflation, does it cost more to visit Disney today than it did in 1971? 


# Data

To ask these questions I needed data. It wasn't hard to find websites with the history of the price for admission to the Magic Kingdom (not a park hopper. I used the data from this [site](http://allears.net/walt-disney-world/wdw-planning/wdw-ticket-increase-guide/) and cross referenced it [here](https://www.travelandleisure.com/trip-ideas/disney-vacations/disney-world-ticket-costs-over-time). I got the dates for the Disney CEOs from the book [Disney War](https://en.wikipedia.org/wiki/DisneyWar) by James B. Stewart and cross referenced them the links in the above Wikipedia article. If I included the wrong data in this post, please let me know and point me to your source so I can correct the record.

Because this is a data science blog, I've kept the code in the post and here is a link to the [repository](https://github.com/butterflyology/Theme_Park_prices) where the dataset and `R` code for this post live.

Throughout these posts, I will follow a set of best practices for data science that aspiring data scientists should also adopt. In particular, I follow the [Google style guide](https://google.github.io/styleguide/Rguide.xml) for my code and store my code in a place that anyone can find it. 

Here, we take care of some preliminaries that include setting the random seed and importing `R` packages we will use througout this project.

```{r prelims}
set.seed(982352)
options("getSymbols.warning4.0" = FALSE)

library("tidyverse") # This is a "meta-package" that contains lots of other useful packages, like ggplot2 and readr.
library('kableExtra') # We will use this to generate a nice looking table in `html`.
library("lubridate") # we will need some functions from here to work with date data
library("quantmod") # we will use this to get consumer price index data
library("magicfor") # package to save output from a for loop
```


Here we import the and check the data to ensure everything was imported properly. I am using the `tidyverse` suite of packages, which have a slightly different syntaax than base `R`. There are three columns in the data set:

1. `Date` - The date the admission price was in effect. It is formatted as in ISO-8601 (`YYYY-MM-DD`), which can be parsed using the code `%Y-%m-%d`.
1. `Price` - The cose of single-day admission to the Magic Kingdom
1. `CEO` - The Disney CEO at the time of the price.

```{r import}
data <- read_csv("../data/MK_prices.csv", col_names = TRUE, col_types = cols(Date = col_date("%Y-%m-%d"), Price = col_double(), CEO = col_character()))

col_names <- c("Date", "Price (USD)", "CEO")
knitr::kable(x = data, format = "html", align = "c", col.names = col_names) %>%
  row_spec(row = 1:2, align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  scroll_box(width = "650px", height = "300px")
```


# Visualize

You always want to look at the data. Here are the dates of the increases on the horizontal axis (x-axis) and the cost of admission to the Magic Kingdom on the vertical axis (y-axis) in US Dollars. 

```{r plot_1, eval = FALSE}
data %>% 
  ggplot(aes(x = Date, y = Price, col = CEO)) +
  geom_point(size = 2.5) +
  scale_color_discrete(breaks = c("Disney", "Tatum", "Walker", "Miller", "Eisner", "Iger")) +
  theme_bw() + 
  theme(legend.position = c(0.15, 0.75), legend.text = element_text(size = 15)) +
  labs(y = "Price (USD)")
```

Does it look like Mr. Iger has upped the rate of admission increases faster than the other CEOs? Maybe. But this isn't an apples to apples comparison. This is nice and all but isn't as informative as we need for a meaningful inference. We need to adjust the prices for inflation. We will adjust inflation using the "Consumer Price Index for All Urban Consumers: All Items" from the rockstars over at the Bureau of Labor Statistics.

We will pull out the Consumer Price Index (CPI) for the dates the admission prices went into effect and normalize them based on a 1971 baseline (the year WDW opened). Then we will join these values and convert the older prices to 2018 US Dollars. We could go to a website like the St. Louis Federal Reserve Bank and manually look up the adjustments, but why do that when we could write code?


```{r CPI, warnings = FALSE}
getSymbols("CPIAUCSL", src = "FRED")
str(CPIAUCSL)

avg.cpi <- apply.yearly(CPIAUCSL, mean)
avg_cpi <- data.frame(Date = index(avg.cpi), avg.cpi)
rownames(avg_cpi) <- NULL
avg_cpi <- avg_cpi %>% 
  mutate(Year = year(Date)) %>%
  select(-Date)

# inelegant, but it works
# Add a column wit the year to our data set, we will join by this column
new_data <- data %>% 
  mutate(Year = year(Date))
magic_for(print, silent = TRUE)
for(year in new_data$Year){
  print(tail(avg_cpi$CPIAUCSL / avg_cpi[avg_cpi$Year == year, 1], 1))
}
adjustment <- magic_result_as_dataframe() 
colnames(adjustment) <- c("Year", "ADJ")

newer_data <- left_join(x = new_data, y = adjustment, by = "Year")
newer_data <- newer_data %>% 
  mutate(ADJ_Price = Price * ADJ)
```


Now we have our admission prices adjusted for inflation.


# Questions 1 & 2

The first two questions are related. To refresh your recollection: 

1. Has the rate of increase gotten higher recently?
1. Did the different Disney CEOs raise ticket prices at different rates? 

Let's look at the rate of increase for each CEO. We will fit a linear regression for each CEO and plot it to the data. We will use the same plot as before and overlay the lines to it. Roy O. Disney was CEO for only one price point and won't get a line. 

The code is the same as above with just one line added:

`geom_smooth(method = "lm", formula = y ~ x, se = TRUE, show.legend = FALSE, level = 0.95)`

```{r lines, echo = FALSE, warning = FALSE}
newer_data %>% 
  ggplot(aes(x = Date, y = ADJ_Price, col = CEO)) +
  geom_point(size = 2.5) +
  scale_color_discrete(breaks = c("Disney", "Tatum", "Walker", "Miller", "Eisner", "Iger")) +
  theme_bw() + 
  theme(legend.position = c(0.15, 0.75), legend.text = element_text(size = 15)) +
  labs(y = "Adjusted Price (USD)") +
  geom_smooth(method = "lm", formula = y ~ x, se = TRUE, show.legend = FALSE, level = 0.95)
```

The lines running through the data represent 
The shaded reagions around the lines represent the confidence interval around the line.

Are the slopes between Michael Eisner and Bob Iger the same? They don


Let's select the rows from our data that are associated with Eisner or Iger. 
```{r, eval = FALSE}
Eisner_Iger <- data %>% 
  filter(CEO == "Eisner" | CEO == "Iger")



```

